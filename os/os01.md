# 01 Introduction to Operating System

以下にはコードが登場します

Cをコンパイルした結果のアセンブリが見たいときは<https://gcc.godbolt.org/>を使ってください

## OSとは

OSはコンピュータを動かす際に**最も基本的なソフトウェア**です

- 情報がどの記憶装置にあるのかという違いを考慮せずにプログラムを書くことを可能にします
- 同時に複数のプログラムが,プログラマーがいちいち書かずに動かせるようになります
  - ブラウザ,メールクライアント,ゲームなどを並行して動かせます
- バグによってメモリが破壊されないようになっています

### 実例

- Windows, Linux, Solaris, BSD, Mach,...
  - Mac OSはBSDがベース
  - AndroidはLinuxがベース
  - Windows以外のOSはUnixというOSから派生

## なぜ学ぶのか

OSは根幹的なシステムなのでこれを学ぶことで多くの応用へと繋がります

### 実用プログラムの基本

- OSの根本的な部分の勉強を勉強するとネットワークをプログラムから利用可能にするソフトウェアが書けるようになる
- ライブラリ,プログラミング言語などで使われる機能の実装方法を理解できます
- セキュリティへのより深い理解

### 効率的なプログラムとそうでないプログラムを理解することができます

- OSは高速にプログラムの間を切り替えて実行おり,その中の動きを理解しなければプログラムに対する選択の良し悪しがわかりません

### OSの細かい機能はどうでも良いという人

- OSののAPIを組み合わせる際に,OSを持つ機能を理解していれば必要に応じてマニュアルを見るという正しい手法をすることができます
- マニュアルを読む際にOSの背景知識が必要になることが多く,マニュアルを読んで理解することも可能です

## OSの役割

OSには以下のような役割が有ります

- 計算機資源を抽象化･仮想化します
- プロセス間の隔離,計算機資源の管理

### 抽象化･仮想化(便利な側面)

- ハードウェアとソフトウェアの間に入るような機能を提供しています(**仮想化**)
ナマのハードウェアではやりにくい出入力などを扱ったり,OSを簡単に扱えるようなAPIを提供しています

- また,実際は複数のプログラムで計算資源を共有しているのですが,それを意識しなくても使うことができます(**抽象化**)
CPUやメモリでプログラムの資源の割当をうまくしています

### プロセス間の隔離,計算機資源の管理(安全な側面)

- プロセス間の隔離とは他の人が自分のプログラムを閲覧したり,破壊できないようにする機能です
- 計算資源の管理とはあるユーザーがCPUやメモリを独占的に利用できないようにしています

### システムコール

**システムコール**を呼び出すことで,実行が面倒な仕事(入出力,計算資源の割当)を実行できます

また,システムコールを介してでないと資源を利用できないようにすることで安全性を保証しています

## 安全性をどう実現をするのか

ファイルを読み書きするシステムコールは`open`, `read`, `write`です(便利な側面)

**これらを通してしか**ファイルにアクセスができないようにすれば安全です

しかし,その保証は自明ではありません

というのもディスクにアクセスするというプログラム,OSの動作の真似をすれば誰でもアクセスができそうです

### CPUの仕組み

#### 命令･モード

命令には2種類あります

- 非特権命令
- 特権命令

CPUの動作状態にも2種類あります

- ユーザーモード(非特権)
- スーパバイザモード(特権)

CPUによっては更に細分化する場合が有ります

特権命令(入出力命令,一部のメモリ領域へのアクセスなど)は特権モードでのみ実行可能とします

これによって普段行っているプログラムは非特権命令なので,保護をすることができます

#### トラップ命令

**トラップ命令**とは｢特権モードへ移行+特定番地へジャンプ｣という命令です

｢特権モードへ移行｣という命令と｢特定番地へジャンプ｣という命令を同時にすることで他の命令では実現できないようにできます

トラップ命令はユーザモードで実現可能です

特定番地を決めるのは**割り込みベクタ**と呼ばれるメモリ上の表です

割り込みベクタは特権命令によって設定されます

### 安全性のためのOSの仕組み

アプリケーションが特権命令を実行しようと思った時は,

システムコール(トラップ命令)→特権命令(非特権命令も使う)

ここではアプリケーションとOSをシステムコールが結び,OSとCPUを特権命令が繋いでいます(非特権命令も)

## まとめ

- スレッドとプロセス(CPUの抽象化･管理)
- 仮想記憶,アドレス空間(メモリの抽象化･管理)
- ファイルシステム
- プロセス間通信(ソケット)
- 認証とセキュリティ
